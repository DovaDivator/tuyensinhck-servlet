import{r as o,j as e,u as B,a as T,s as L,h as A,B as q,g as J,d as K,e as z,b as Q,c as W,H as Y,L as P}from"./index-qv2f6qUe.js";import{u as X}from"./index-DRIBn9qH.js";import{H as Z}from"./Header-BwPZUt6b.js";import{t as ee,M as te,B as j}from"./MainWarpper-Dh6EhIZe.js";import{I as y,a as S,b as E}from"./InputField-Bs1ecEZR.js";import{c as V}from"./checkValidSubmitUtils-Bid7X6wl.js";import{a as k}from"./alertBasic-BlckFawB.js";import{L as G}from"./ListTable-mOjGfO5l.js";import{a as se}from"./alerlSimpleInput-yPCRcWkj.js";import{I as M,C as ne,b as U,c as ae}from"./base64ToFile-DY9lArFe.js";import{f as D}from"./formatTimestamp-CaO187jo.js";import{G as re,U as ie,g as oe,u as ce,d as le}from"./StudentExam-Dj7XA_J1.js";import{D as he}from"./DatetimePicker-OnKih5tk.js";import{C as de}from"./ChoiceValids-DDD_5smu.js";import{D as F}from"./Dropdown-CyRi64eP.js";import{g as me}from"./GetMonHoc-B5pGtDKO.js";import{a as ue}from"./alertForm-CVZZy8_w.js";/* empty css                   */import"./useScrollbar-BJwbBr6P.js";import"./parseFlexibleDate-Ccvibv4l.js";const ge=({children:t,delay:a=0,className:n=""})=>(o.useEffect(()=>{a!==0&&ee(".info-background__content",a)},[]),e.jsx("div",{className:`info-background ${n}`,children:e.jsxs("div",{className:"info-background__content",children:[e.jsx(Z,{}),e.jsx(te,{className:"info",children:t})]})})),fe=async(t,a)=>{try{const n=await fetch("/api/change-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(a),credentials:"include"}),s=await n.text(),r=await JSON.parse(s);if(!n.ok){const i={status:n.status,message:r.message};throw console.error(i),i}return r}catch(n){throw n instanceof TypeError&&n.message.includes("Failed to fetch")?{status:503,message:"Không thể kết nối đến máy chủ."}:n}},xe=()=>{const{isLoading:t,setIsLoading:a}=B(),{token:n}=T(),[s,r]=o.useState({currentPassword:"",newPassword:"",comfirmPassword:""}),[i,d]=o.useState({currentPassword:"",newPassword:"",comfirmPassword:""}),[c,m]=o.useState(!1),g={currentPassword:new E({restrict:!0}),newPassword:new E({restrict:!0}),comfirmPassword:new E({restrict:!0})},l={currentPassword:new y({minlength:6,required:!0,matchType:["password"]}),newPassword:new y({minlength:6,required:!0,matchType:["password"]}),comfirmPassword:new y({minlength:6,required:!0,matchType:["password"],match:"newPassword"})},x=async p=>{if(p.preventDefault(),m(!0),!await V(s,l,d)){L("error","","Vui lòng kiểm tra lại thông tin!"),m(!1);return}const f=await A(String(s.currentPassword)),v=await A(String(s.newPassword));try{const N=await fe(n,{curPass:f,newPass:v});console.log(N),N.success&&L("success","","Đổi mật khẩu thành công!")}catch(N){console.error(N),N.status===401?k({icon:"error",title:"Đổi mật khẩu thất bại!",message:"Mật khẩu cũ hoặc mới không đúng!"}):k({icon:"error",title:"Lỗi không xác định!",message:"Có số lỗi xảy ra trong quá trình đổi mật khẩu. Vui lòng thử lại sau."})}m(!1)};return e.jsxs("section",{className:"switch-password-form-container",children:[e.jsx("h3",{children:"Thay đổi mật khẩu"}),e.jsxs("form",{onSubmit:x,id:"switch-password-form",noValidate:!0,children:[e.jsx(S,{type:"password",name:"currentPassword",id:"currentPassword",placeholder:"Mật khẩu cũ",value:s.currentPassword,maxLength:20,formData:s,setFormData:r,options:g.currentPassword,errors:i,setErrors:d,valids:l.currentPassword,isSubmiting:c}),e.jsx(S,{type:"password",name:"newPassword",id:"newPassword",placeholder:"Mật khẩu mới",value:s.newPassword,maxLength:20,formData:s,setFormData:r,options:g.newPassword,errors:i,setErrors:d,valids:l.newPassword,isSubmiting:c}),e.jsx(S,{type:"password",name:"comfirmPassword",id:"comfirmPassword",placeholder:"Xác nhận mật khẩu",value:s.comfirmPassword,maxLength:20,formData:s,setFormData:r,options:g.comfirmPassword,errors:i,setErrors:d,valids:l.comfirmPassword,isSubmiting:c}),e.jsx(j,{type:"submit",text:t?"Đang xác nhận...":"Cập nhật",disabled:t})]})]})},pe=t=>t===""||typeof t===void 0||t===null?"Không xác định":String(t),we=async(t,a)=>{try{const n=await fetch("/api/change-user",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(a),credentials:"include"}),s=await n.text(),r=await JSON.parse(s);if(!n.ok){const i={status:n.status,message:r.message};throw console.error(i),i}return r}catch(n){throw n instanceof TypeError&&n.message.includes("Failed to fetch")?{status:503,message:"Không thể kết nối đến máy chủ."}:n}},je=()=>{const{token:t}=T(),a="Chỉ có thể cập nhật dựa trên CCCD bạn đã thêm vào!",[n,s]=o.useState(new q("","",0,"","","",""));return t===""?e.jsx(e.Fragment,{}):(o.useEffect(()=>{(async()=>{if(t!=="")try{const i=await J(t);s(i)}catch(i){console.error(i)}})()},[t]),e.jsxs("section",{className:"base-infomation",children:[e.jsx("h3",{children:"Thông tin cá nhân"}),e.jsx("figure",{className:"base-infomation__avatar",children:e.jsx("img",{src:n.getImage(),alt:"Avatar",title:a})}),e.jsxs("div",{className:"base-infomation__title",children:[e.jsx("h3",{title:a,className:"not-allow-hover",children:n.name}),e.jsxs("span",{children:["ID: ",n.id]}),e.jsxs("i",{children:["Vai trò: ",n.getRoleName()]})]}),e.jsxs("div",{className:"base-infomation__contact",children:[e.jsxs("div",{className:"line",children:[e.jsxs("span",{children:[e.jsx("b",{children:"Email: "}),n.email]}),e.jsx(j,{className:"custom_info",icon:"fa-solid fa-pen-to-square",onClick:()=>O("email",n,s,t),title:"Chỉnh sửa"})]}),e.jsxs("div",{className:"line",children:[e.jsxs("span",{children:[e.jsx("b",{children:"SĐT: "}),pe(n.phone)]}),e.jsx(j,{className:"custom_info",icon:"fa-solid fa-pen-to-square",onClick:()=>O("số điện thoại",n,s,t),title:"Chỉnh sửa"})]}),e.jsx("div",{className:"line",children:e.jsxs("span",{children:[e.jsx("b",{children:"Ngày tạo: "}),n.getDateString()]})})]}),n.isStudent()&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"horizontal-lines"}),e.jsx(Ne,{stu_id:n.id})]}),n.isStudent()&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"horizontal-lines"}),e.jsx(Ce,{stu_id:n.id})]})]}))},Ne=({stu_id:t=""})=>e.jsxs("div",{className:"base-infomation__cccd-info",children:[e.jsx("h3",{children:"Thông tin Căn cước"}),e.jsxs("div",{className:"base-infomation__cccd-info__content",children:[e.jsxs("span",{children:[e.jsx("b",{children:"Số CCCD: "})," "]}),e.jsxs("span",{children:[e.jsx("b",{children:"Ngày sinh: "})," "]}),e.jsxs("span",{children:[e.jsx("b",{children:"Giới tính: "})," "]}),e.jsxs("span",{children:[e.jsx("b",{children:"Địa chỉ: "})," "]})]}),e.jsx("span",{className:"error-message",children:"Lưu ý: Thông tin đã cập nhật sẽ không thể thay đổi được!"})]}),Ce=({stu_id:t=""})=>e.jsxs("div",{className:"base-infomation__nganh-dk",children:[e.jsx("h3",{children:"Ngành học đã đăng ký"}),e.jsx(G,{error:"Bạn chưa đăng ký ngành học nào!"})]}),O=async(t,a,n,s)=>{const r=new y({});let i="";switch(t){case"email":r.matchType=["email"],r.required=!0,i="email";break;case"số điện thoại":r.matchType=["phone"],i="phone";break;default:console.error(`tên ${t} không xác định trong case`);return}const d=await se({title:`Thay đổi ${t}`,valid:r,inputValue:a[i]});if(console.log(d),d.isConfirmed){if(d.value===a[i])return;try{const c=await we(s,{name:i,value:d.value});if(!c.success)throw new Error(c.message);n(new q(a.id,a.name,a.role,a.avatarImg,i==="email"?d.value:a.email,i==="phone"?d.value:a.phone,a.created_at)),L("success","","Cập nhật thành công!")}catch(c){console.error(c),k({icon:"error",title:"Thông báo lỗi",message:c.message||"Không thể tải thông tin người dùng"})}}},ye=()=>{const{token:t,user:a}=T(),{isLoading:n,setIsLoading:s}=B(),r=["Thông tin của bạn đang chờ phê duyệt!","Bạn đã cập nhật CCCD!"],[i,d]=o.useState(-1),c=o.useRef(null),m=o.useRef(null),[g,l]=o.useState({numCccd:"",dateBirth:D(new Date(new Date().getFullYear()-18,0,1)),gender:"",address:""}),[x,p]=o.useState({front:void 0,back:void 0}),[h,f]=o.useState({numCccd:"",dateBirth:"",gender:"",address:""}),v={front:new M({required:!0}),back:new M({required:!0}),dateBirth:new he({required:!0,cons:{max:{value:new Date(new Date().getFullYear()-16,11,31)}}}),realName:new y({required:!0}),gender:new de({required:!0}),address:new y({required:!0}),numCccd:new y({required:!0,minlength:12,matchType:["cccd"]})};if(t===""||a.isGuest())return e.jsx(e.Fragment,{});o.useEffect(()=>{t&&(async()=>{try{const u=await re(t);typeof u.data.confirm<"u"&&d(parseInt(u.data.confirm));const b={realName:u.data.realName||"",numCccd:u.data.numCccd||"",dateBirth:u.data.dateBirth?D(u.data.dateBirth):D(new Date(new Date().getFullYear()-18,0,1)),gender:u.data.gender||"",address:u.data.address||""},R={front:u.data.front===void 0?u.data.front:U("data:image/png;base64,"+u.data.front,"front.png","image/png"),back:u.data.back===void 0?u.data.back:U("data:image/png;base64,"+u.data.back,"front.png","image/png")};l(b),p(R),c.current=b,m.current=R}catch(u){console.error(u)}})()},[t]);const N=()=>{c.current&&m.current?(l(c.current),p(m.current)):console.warn("Dữ liệu mặc định chưa được khởi tạo")},H=async()=>{if(s(!0),!V({...g,...x},v,f)){s(!1);return}const u=await ae(x);try{const b=await ie(t,{...g,...u});console.log(b)}catch(b){console.error(b)}s(!1)};return e.jsxs("section",{className:"cccd-form-container",children:[e.jsx("h3",{children:"Thêm Căn cước công dân"}),i>=0&&e.jsx("p",{className:"note",children:r[i]}),e.jsx(ne,{formData:g,setFormData:l,imgData:x,setImgData:p,errors:h,setErrors:f,valids:v,status:i}),e.jsxs("div",{className:"button-form",children:[e.jsx(j,{type:"button",className:"btn-confirm",onClick:H,text:"Cập nhật!",disabled:n||i===1}),e.jsx(j,{type:"button",className:"btn-cancel",onClick:N,text:"Khôi phục",disabled:n})]})]})},ke=K.memo(ye),w=["Toán tư duy","Tiếng việt","Môn chuyên","Ngoại ngữ"],be=t=>{const a=t;return a.dsThi.length===0?[{ttMon:1,mon_thi:w[0]},{ttMon:2,mon_thi:w[1]},{ttMon:3,mon_thi:t.monTC||w[2]},{ttMon:4,mon_thi:t.monNN||w[3]}]:a.dsThi.map(n=>{let s="",r=null;switch(n.ttMon){case 1:s=w[0],r=t.ketQua.diemToan;break;case 2:s=w[1],r=t.ketQua.diemVan;break;case 3:s=t.monTC||w[2],r=t.ketQua.diemTC;break;case 4:s=t.monNN||w[3],r=t.ketQua.diemNN;break;default:s="Không xác định",r=null}return{...n,mon_thi:s,diem:r}})},Te=({setFormData:t,defaultValue:a={monTC:"",monNN:""},setIsNotChange:n})=>{const[s,r]=o.useState({monTC:"",monNN:""}),[i,d]=o.useState({monTC:[],monNN:[]});n(!0);const c=(g,l)=>{var x;return((x=l.find(p=>p.label===g))==null?void 0:x.value)||""},m=o.useRef({monTC:"",monNN:""});return o.useEffect(()=>{(async()=>{try{const l=await me();if(console.log(l),!l.data)throw new Error("Không có dữ liệu");d(l.data),m.current={monTC:c(String(a.monTC),l.data.monTC),monNN:c(String(a.monNN),l.data.monNN)},r(m.current)}catch(l){console.error(l)}})()},[]),o.useEffect(()=>{t?(t({monTC:String(s.monTC||""),monNN:String(s.monNN||"")}),n(s.monTC===m.current.monTC&&s.monNN===m.current.monNN)):console.warn("setFormData không được truyền vào")},[s,t,m]),e.jsxs("div",{style:{height:"270px"},children:[e.jsx("label",{style:{marginBottom:"6px",display:"block"},children:"Chọn môn học quản lý:"}),e.jsx(F,{name:"monTC",id:"monTC",label:"môn tự chọn",value:String(s.monTC),setFormData:r,choices:i.monTC}),e.jsx(F,{name:"monNN",id:"monNN",label:"môn ngoại ngữ",value:String(s.monNN),setFormData:r,choices:i.monNN})]})},ve=[{value:"dh",label:"Đại học"},{value:"cd",label:"Cao đẳng"},{value:"lt",label:"Liên thông"}],Se=()=>{const{token:t,user:a}=T(),{isLoading:n,setIsLoading:s}=B(),[r]=z(),i=r.get("kyThi")||"",d=r.get("khoa")||"",[c,m]=o.useState({kyThi:i,khoa:d});if(t===""||a.isGuest())return e.jsx(e.Fragment,{});const[g,l]=o.useState([]),[x,p]=o.useState(!1);return o.useEffect(()=>{const h=async()=>{try{const f=await oe(t,{kyThi:i,khoa:d});f.data instanceof Array?l(f.data):l([])}catch(f){console.error(f)}p(!1)};s(!0),(t||x)&&h(),s(!1)},[t,x]),e.jsxs("section",{className:"tra-cuu-container",children:[e.jsx("h3",{children:"Tra cứu kỳ thi"}),e.jsxs("form",{children:[e.jsx("span",{style:{fontWeight:"bold"},children:"Bộ lọc:"}),e.jsx(F,{name:"kyThi",id:"kyThi",label:"kỳ thi",value:String(c.kyThi),setFormData:m,choices:ve,allowDefault:!0}),e.jsx(S,{type:"number",name:"khoa",id:"khoa",value:c.khoa,formData:c,setFormData:m,placeholder:"Khóa thi"}),e.jsx(j,{type:"submit",text:"Tìm kiếm",icon:"fa-solid fa-magnifying-glass"})]}),g.length===0&&e.jsx(Ee,{}),g.length>0&&e.jsx("div",{className:"exam-list",children:g.map((h,f)=>e.jsxs(e.Fragment,{children:[e.jsx("section",{children:e.jsx(De,{token:t,item:h,setIsChange:p})},f),f<g.length-1&&e.jsx("div",{style:{height:"1px",width:"100%",justifyItems:"center"},children:e.jsx("div",{style:{height:"100%",width:"50%",maxWidth:"600px",backgroundColor:"gray"}})})]}))})]})},Pe=K.memo(Se),Ee=()=>e.jsx("div",{className:"container text-center mt-5",children:e.jsx("div",{className:"alert alert-warning",children:e.jsx("span",{children:"Có vẻ bạn chưa đăng ký kỳ thi này của chúng tôi..."})})}),De=({token:t,item:a,setIsChange:n})=>{const s=a,r={mon_thi:"Môn thi",dateExam:"Ngày thi",timeStart:"Bắt đầu",timeEnd:"Kết thúc",maPhong:"Mã phòng",viTri:"Địa điểm",diem:"Điểm"},i=be(a);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"exam-header",children:[e.jsxs("div",{className:"exam-title",children:[e.jsxs("h3",{children:["Kỳ thi ",s.he," khóa ",s.khoa]}),e.jsxs("span",{children:["ID thí sinh: ",s.examId?s.examId:""]})]}),!s.examId&&e.jsxs("div",{className:"button-group",children:[e.jsx(j,{type:"button",icon:"fa-solid fa-pencil",onClick:()=>_e({token:t,data:{typeExam:s.he,idRegister:s.idRegister},setIsChange:n,defaultValue:{monTC:s.monTC,monNN:s.monNN}}),className:"btn-confirm",title:"Chỉnh sửa thông tin"}),e.jsx(j,{type:"button",icon:"fa-solid fa-xmark",onClick:()=>{Ie({token:t,id:s.idRegister,setIsChange:n})},className:"btn-cancel",title:"Hủy đăng ký"})]})]}),e.jsx("div",{children:e.jsx(G,{struct:i,headers:r})})]})},_e=async({token:t,data:a,setIsChange:n,defaultValue:s={monTC:"",monNN:""}})=>{const r=await ue(Te,{defaultValue:s},{},!0);if(!(!r.isConfirmed||r.value===""))try{const i=await ce(t,{...a,...r.value});k({icon:"success",title:"Thành công",message:"Đã sửa thông tin thành công",timer:5e3}).then(()=>{n(!0)})}catch(i){k({title:"Lỗi",message:"Không cập nhật thành công!"}),console.error("Thất bại",i)}},Ie=async({token:t,id:a,setIsChange:n})=>{try{const s=await le(t,{id:a});k({icon:"success",title:"Thành công",message:"Đã sửa thông tin thành công",timer:5e3}).then(()=>{n(!0)})}catch(s){k({title:"Lỗi",message:"Không cập nhật thành công!"}),console.error("Thất bại",s)}},C={allUser:["thong-tin-ca-nhan","doi-mat-khau"],studentCase:["cap-nhat-cccd","tra-cuu-ky-thi"],teacherCase:[],adminCase:[]},_={"thong-tin-ca-nhan":e.jsx(je,{}),"doi-mat-khau":e.jsx(xe,{}),"cap-nhat-cccd":e.jsx(ke,{}),"tra-cuu-ky-thi":e.jsx(Pe,{})},I={"thong-tin-ca-nhan":"Thông tin cá nhân","doi-mat-khau":"Thay đổi mật khẩu","cap-nhat-cccd":"Cập nhật CCCD","tra-cuu-ky-thi":"Tra cứu kỳ thi"},Ze=()=>{const t=Q(),{type:a}=W(),{user:n}=T(),[s,r]=o.useState(!1),i=(h,f)=>C.allUser.includes(h)?!0:C.studentCase.includes(h)?f.isStudent():C.teacherCase.includes(h)?f.isTeacher():C.adminCase.includes(h)?f.isAdmin():!1,{ref:d,inView:c}=X({triggerOnce:!0,threshold:.2});o.useEffect(()=>{s&&t("/info/thong-tin-ca-nhan")},[s]);const m=["hide","start"],[g,l]=o.useState(m[0]);o.useEffect(()=>{c&&l(m[1])},[c]);const x=()=>e.jsx("div",{className:"left-menu",children:e.jsxs("ul",{children:[e.jsx("li",{className:a===C.allUser[0]?"active":"",children:e.jsx(P,{to:"/info/thong-tin-ca-nhan",children:I["thong-tin-ca-nhan"]})}),n.isStudent()&&C.studentCase.map(h=>h in _?e.jsx("li",{className:a===h?"active":"",children:e.jsx(P,{to:`/info/${h}`,children:I[h]})},h):null),e.jsx("li",{className:a===C.allUser[1]?"active":"",children:e.jsx(P,{to:"/info/doi-mat-khau",children:I["doi-mat-khau"]})})]})}),p=()=>{if(n.isGuest())return e.jsx(e.Fragment,{});const h=a||"";return i(h,n)&&_[h]?_[h]:(r(!0),e.jsx(e.Fragment,{}))};return e.jsxs("div",{children:[e.jsx(Y,{children:e.jsx("title",{children:"Cá nhân - Web tuyển sinh"})}),e.jsxs(ge,{children:[e.jsx(x,{}),e.jsx("div",{ref:d,className:`right-side ${g}`,children:e.jsx(p,{})})]})]})};export{Ze as default};
