import{j as n,H as et,a as at,u as st,b as nt,r as o,e as ot}from"./index-qv2f6qUe.js";import{I as rt}from"./IndexBackground-BPIzxaN0.js";import{D as F}from"./Dropdown-CyRi64eP.js";import{a as _,b as it}from"./InputField-Bs1ecEZR.js";import{B as K}from"./MainWarpper-Dh6EhIZe.js";import{L as ct}from"./ListTable-mOjGfO5l.js";import{P as ht}from"./Pagination-DIHzGXT1.js";import{a as lt}from"./GetMonHoc-B5pGtDKO.js";import"./Header-BwPZUt6b.js";import"./LogoGuest-DAj0gcma.js";import"./ChoiceValids-DDD_5smu.js";/* empty css                   */import"./useScrollbar-BJwbBr6P.js";const mt=async(r,s)=>{try{const e=await fetch("/api/grading?type=list",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(s),credentials:"include"}),u=await e.text(),i=await JSON.parse(u);if(!e.ok){const f={status:e.status,message:i.message};throw console.error(f),f}return i}catch(e){throw e instanceof TypeError&&e.message.includes("Failed to fetch")?{status:503,message:"Không thể kết nối đến máy chủ."}:e}},ut=async(r,s)=>{console.log(s);try{const e=await fetch("/api/grading?type=update",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(s),credentials:"include"}),u=await e.text(),i=await JSON.parse(u);if(!e.ok){const f={status:e.status,message:i.message};throw console.error(f),f}return i}catch(e){throw e instanceof TypeError&&e.message.includes("Failed to fetch")?{status:503,message:"Không thể kết nối đến máy chủ."}:e}},dt=(r,s,e=new H({}),u={})=>{if(e.required&&s.trim()==="")return{[r]:"Trường này là bắt buộc."};const i=Number(s);return typeof i!="number"||isNaN(i)?{[r]:"Kiểu dữ liệu không hợp lệ."}:e.blockDemical&&!Number.isInteger(i)?{[r]:"Trường không chấp nhận số thập phân."}:e.minLimit!==void 0&&i<e.minLimit?{[r]:`Số nhập vào quá nhỏ : ${e.minLimit}`}:e.maxLimit!==void 0&&i>e.maxLimit?{[r]:`Số nhập vào quá lớn : ${e.maxLimit}`}:{[r]:""}};class H{constructor({minLimit:s=void 0,maxLimit:e=void 0,required:u=!1,blockDemical:i=!1}={}){this.minLimit=s,this.maxLimit=e,this.required=u,this.blockDemical=i}validate(s,e,u){return dt(s,e,this,u)}}const L=30,gt=r=>new Promise(s=>setTimeout(s,r)),Ct=()=>n.jsxs("div",{children:[n.jsx(et,{children:n.jsx("title",{children:"Chấm điểm - Web tuyển sinh"})}),n.jsx(rt,{children:n.jsx(xt,{})})]}),pt=[{value:"dh",label:"Đại học"},{value:"cd",label:"Cao đẳng"},{value:"lt",label:"Liên thông"}],ft={examId:"Mã thí sinh",maPhong:"Mã phòng",monThi:"Môn thi",diemInput:"Điểm"},xt=()=>{const{user:r,token:s}=at(),{setIsLoading:e,isLoading:u}=st(),i=nt(),[f,N]=o.useState([]),[g,E]=o.useState(!0),[w,d]=o.useState(!0),[v,p]=o.useState(!1),[D,C]=o.useState(!1),[b,$]=o.useState(""),[G,V]=o.useState([]),[P,z]=o.useState({curNum:1,totalPage:1}),k=o.useRef([]),[I,M]=o.useState([]),[j,W]=o.useState([]),[X,Q]=o.useState([]),[S,R]=o.useState({}),[Y,q]=o.useState({}),[B,O]=o.useState({});r.isAdmin()||r.isTeacher()||i("/");const[t,T]=o.useState({he:"dh",khoa:"",monThi:"",search:"",phong:""}),[y]=ot();o.useEffect(()=>{s&&(async()=>{try{const a=await lt(s);N(a.data);const c=y.get("he")||"dh",h=y.get("khoa")||"",l=y.get("monThi"),x=y.get("search")||"",A=y.get("phong")||"";T({he:c,khoa:h,monThi:l??(a.data.length>0?a.data[0].value:""),search:x,phong:A})}catch(a){console.error(a)}})()},[]),o.useEffect(()=>{const m=y.get("he")||"",a=y.get("khoa")||"",c=y.get("monThi")||"";if(!(m!==t.he||a!==t.khoa||c!==t.monThi))return;const l=new URLSearchParams;l.append("he",String(t.he)),String(t.khoa).trim()!==""&&!isNaN(Number(t.khoa))&&l.append("khoa",String(t.khoa)),l.append("monThi",String(t.monThi)),i(`/cham-diem?${l.toString()}`,{replace:!0}),d(!0)},[t.he,t.khoa,t.monThi]),o.useEffect(()=>{w&&((async()=>{e(!0),$("");try{console.log(t);const a=await mt(s,{he:t.he,khoa:t.khoa,monThi:t.monThi});!a.data||Object.keys(a.data).length===0||!a.data.list?k.current=[]:k.current=a.data.list;const c=[];for(const h of a.data.list)c.find(x=>x.value===h.maPhong)||c.push({label:h.maPhong,value:h.maPhong});V(c),C(!0),p(!1),E(a.data.allow),M(k.current)}catch(a){console.error(a),$("Có sự cố xảy ra")}finally{e(!1)}})(),d(!1))},[w]),o.useEffect(()=>{(()=>{const a=I.map((c,h)=>({...c,index:h})).filter(c=>c.examId.includes(t.search)&&(t.phong===""||c.maPhong===t.phong));W(a),D&&(z({curNum:1,totalPage:Math.ceil(a.length/L)}),C(!1))})()},[I,t.search,t.phong]),o.useEffect(()=>{C(!0)},[t.search,t.phong]),o.useEffect(()=>{const m=(P.curNum-1)*L,a=Math.min(m+L,j.length),c=[];for(let h=m;h<a;h++){const l=j[h],x={...l,diemInput:n.jsx(_,{id:`item_${l.index}`,name:`item_${l.index}`,value:(S==null?void 0:S[`item_${l.index}`])||"",formData:S,setFormData:R,options:new it({restrict:!0}),valids:new H({minLimit:0,maxLimit:10}),errors:Y,setErrors:q,disabled:!g})};c.push(x)}Q(c)},[S]),o.useEffect(()=>{(async()=>{v?await U(S,k.current,I,M,B,O):O({}),p(!0);const a=(P.curNum-1)*L,c=Math.min(a+L,j.length),h={},l={};console.log(j);for(let x=a;x<c;x++){const A=j[x],J=`item_${A.index}`;h[J]=String(A.diem??""),l[J]=""}R(h),q(l)})()},[P,t.search,t.phong,k.current]);const Z=()=>{d(!0)},tt=async m=>{if(console.log(m),Object.keys(m).length!==0)try{const a=await ut(s,{data:m,he:t.he,khoa:t.khoa,monThi:t.monThi});a&&console.log(a),d(!0)}catch(a){console.error(a)}};return n.jsxs("div",{className:"manager-exam-result-body",children:[n.jsxs("section",{className:"manager-exam-result-header",children:[n.jsx("h2",{className:"title",children:"Chấm điểm"}),n.jsx("p",{className:"description",children:"Vui lòng chọn kỳ thi và môn thi để chấm!"}),n.jsxs("form",{children:[n.jsxs("div",{className:"dropdown-grid",children:[n.jsx(F,{name:"he",id:"he",choices:pt,value:String(t.he),setFormData:T,label:"Kỳ thi"}),n.jsx(_,{type:"number",id:"khoa",name:"khoa",value:t.khoa,formData:t,setFormData:T,placeholder:"khoa"}),n.jsx(F,{name:"monThi",id:"monThi",choices:f,value:String(t.monThi),setFormData:T,label:"môn thi"})]}),n.jsx(_,{name:"search",id:"search",placeholder:"Tìm kiếm",value:t.search,maxLength:70,formData:t,setFormData:T}),n.jsx(F,{name:"phong",id:"phong",choices:G,value:String(t.phong),setFormData:T,label:"Phòng thi",allowDefault:!0})]}),n.jsxs("div",{className:"button-form",children:[n.jsx(K,{type:"button",className:"btn-confirm",onClick:async()=>{const m=await U(S,k.current,I,M,B,O);await tt(m)},text:"Cập nhật!",disabled:u}),n.jsx(K,{type:"button",onClick:Z,text:"Khôi phục",disabled:u})]})]}),n.jsx("span",{className:"error-message",children:"Lưu ý: Dữ liệu sẽ không cập nhật điểm bị nhập sai."}),n.jsxs("section",{className:"manager-exam-result-content",children:[n.jsx(ct,{struct:X,headers:ft,error:b}),n.jsx(ht,{curNum:P.curNum,listLength:P.totalPage})]})]})},U=async(r,s,e,u,i,f)=>{const N=[...s],g={...i};let E=!1;await gt(100);for(const w in r){const d=Number(w.split("_")[1]),v=r[w];let p=null;if(v==="")p=null;else{const b=Number(v);if(isNaN(b)||b<0||b>10)continue;p=Math.round(b*100)/100}if(!s[d]||!s[d].examId)return{};const D=s[d].examId;s[d].diem!==p?(!g.hasOwnProperty(D)||g[D]!==p)&&(g[D]=p):g.hasOwnProperty(D)&&delete g[D],e[d].diem!==p&&(E=!0,N[d]={...N[d],diem:p})}return console.log("sau"),console.log(g),f(g),E&&u(N),g};export{Ct as default};
